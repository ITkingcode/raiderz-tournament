<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RaiderZ PvP Tournament Builder</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link rel="stylesheet" href="css/main.css">
</head>

<body>

<header>
  <div class="left">
    <button id="exportHistoryBtn" class="secondary">Export History</button>
    <button id="importHistoryBtn" class="secondary">Import History</button>
    <input type="file" id="importFile" hidden>
  </div>

  <div class="right">
    <button id="resetBtn" class="danger">Reset</button>
  </div>
</header>

<main>

<h1>
  RaiderZ PvP Tournament Builder<br>
  <small style="color:var(--purple)">Built by Radyan and KoKoRo</small>
</h1>

<div class="section">
  <h2>1. Tournament Info</h2>
  <div class="center">
    <input id="tournamentName" placeholder="Tournament name">
    <input id="tournamentDate" type="date">
  </div>
</div>

<div class="section">
  <h2>2. Tournament Type</h2>
  <div class="center">
    <select id="tournamentType">
      <option value="roundrobin">Round Robin</option>
      <option value="single" disabled>Single Elimination (in development)</option>
    </select>
  </div>
</div>

<div class="section">
  <h2>3. Participants</h2>
  <div class="center">
    <input id="playerName" type="text" placeholder="Player name">
    <button id="addPlayerBtn">Add</button>
  </div>
  <ul id="playerList" class="center"></ul>
</div>

<div class="section">
  <h2>4. Matches</h2>
  <div class="center">
    <button id="generateBtn">Generate Matches</button>
    <button id="shuffleBtn" class="secondary">Shuffle</button>
  </div>
  <div id="matches"></div>
</div>

<div class="section">
  <h2>5. Ranking</h2>

  <div id="exportArea">
    <div class="center" style="margin-bottom:10px">
      <img src="images/kokoro.png" class="kokoro-logo"><br>
      <strong id="exportTitle"></strong><br>
      <small id="exportDate"></small>
    </div>
    <ul id="ranking" class="ranking-list"></ul>
  </div>

  <div class="center">
    <button id="exportImageBtn">Export Image</button>
    <button id="saveHistoryBtn" class="secondary">Save to History</button>
  </div>
</div>

<div class="section">
  <h2>6. Historical Rankings</h2>
  <div id="history"></div>
</div>

</main>

<script>
/* === STATE === */
const historyKey='rz_tournament_history';
let players=[],stats={},matches=[],generated=false;
const el=id=>document.getElementById(id);

/* === PARTICIPANTS === */
el('addPlayerBtn').onclick=addPlayer;
el('playerName').addEventListener('keydown',e=>{if(e.key==='Enter')addPlayer()});

function addPlayer(){
  const n=el('playerName').value.trim();
  if(!n||players.includes(n))return;
  players.push(n);
  stats[n]={w:0,l:0};
  el('playerName').value='';
  renderPlayers();
  renderRanking();
}

function renderPlayers(){
  el('playerList').innerHTML='';
  players.forEach((p,i)=>{
    const li=document.createElement('li');
    li.textContent=`${i+1}. ${p}`;
    el('playerList').appendChild(li);
  });
}

/* === MATCHES === */
el('generateBtn').onclick=generateMatches;
el('shuffleBtn').onclick=shuffleMatches;

// === CORRECCIÓN ROUND ROBIN ===
function generateMatches(){
  if(generated){renderMatches();return;}
  if(players.length<2)return;
  generated=true;
  matches=[];
  const pool=[...players];
  const n=pool.length;
  const isOdd = n % 2 !== 0;
  const playersRR = isOdd ? [...pool, null] : [...pool]; // null será “bye” temporal
  const totalRounds = playersRR.length - 1;

  for(let round=0; round<totalRounds; round++){
    for(let i=0; i<playersRR.length/2; i++){
      const p1 = playersRR[i];
      const p2 = playersRR[playersRR.length-1-i];
      if(p1 && p2) matches.push([p1,p2]);
    }
    // Rotación de jugadores (excepto el primero)
    const last = playersRR.pop();
    playersRR.splice(1,0,last);
  }

  renderMatches();
}

function shuffleMatches(){
  if(!generated)return;
  matches.sort(()=>Math.random()-0.5);
  renderMatches();
}

function renderMatches(){
  const m=el('matches'); m.innerHTML='';
  matches.forEach(([a,b])=>{
    const d=document.createElement('div'); d.className='match';
    const b1=document.createElement('button');
    const b2=document.createElement('button');
    const vs=document.createElement('span'); vs.className='vs'; vs.textContent='VS';
    b1.textContent=a; b2.textContent=b;
    b1.onclick=()=>setWinner(a,b,b1,b2);
    b2.onclick=()=>setWinner(b,a,b2,b1);
    d.append(b1,vs,b2); m.appendChild(d);
  });
}

function setWinner(w,l,wb,lb){
  if(wb.classList.contains('winner'))return;
  wb.classList.add('winner'); lb.classList.remove('winner');
  stats[w].w++; stats[l].l++;
  renderRanking();
}

/* === RANKING === */
function renderRanking(){
  const ul=el('ranking'); ul.innerHTML='';
  [...players].sort((a,b)=>stats[b].w-stats[a].w).forEach((p,i)=>{
    let star='';
    if(i===0)star='<span class="star gold">★</span>';
    if(i===1)star='<span class="star silver">★</span>';
    if(i===2)star='<span class="star bronze">★</span>';
    const li=document.createElement('li');
    li.className='rank-card';
    li.innerHTML=`<div class="rank-left"><div class="rank-pos">${i+1}</div><div>${p} ${star}</div></div><div>${stats[p].w}W-${stats[p].l}L</div>`;
    ul.appendChild(li);
  });
  el('exportTitle').textContent=el('tournamentName').value||'Official Tournament Ranking';
  el('exportDate').textContent=el('tournamentDate').value||new Date().toLocaleDateString();
}

/* === EXPORT IMAGE (FIX) === */
el('exportImageBtn').onclick=()=>{
  if(el('ranking').children.length===0)return alert('Nothing to export');
  html2canvas(el('exportArea'),{
    backgroundColor:'#0b0b10',
    useCORS:true
  }).then(c=>{
    const a=document.createElement('a');
    a.download='tournament.png';
    a.href=c.toDataURL();
    a.click();
  });
};

/* === HISTORY === */
el('saveHistoryBtn').onclick=saveHistory;
el('resetBtn').onclick=resetTournament;

function saveHistory(){
  if(players.length===0)return alert('Nothing to save');
  const h=JSON.parse(localStorage.getItem(historyKey)||'[]');
  h.push({
    name:el('tournamentName').value||'Unnamed',
    date:el('tournamentDate').value||new Date().toLocaleDateString(),
    ranking:[...players].sort((a,b)=>stats[b].w-stats[a].w)
      .map(p=>({name:p,w:stats[p].w,l:stats[p].l}))
  });
  localStorage.setItem(historyKey,JSON.stringify(h));
  renderHistory();
}

function resetTournament(){
  players=[]; stats={}; matches=[]; generated=false;
  el('playerList').innerHTML='';
  el('matches').innerHTML='';
  el('ranking').innerHTML='';
  el('tournamentName').value='';
  el('tournamentDate').value='';
}

function renderHistory(){
  const c=el('history'); c.innerHTML='';
  const h=JSON.parse(localStorage.getItem(historyKey)||'[]');
  h.forEach((t,i)=>{
    const d=document.createElement('div'); d.className='history-card';
    d.innerHTML=`<button class="danger" style="float:right" onclick="deleteHistory(${i})">Delete</button>
      <strong>${t.name}</strong> (${t.date})<br>
      ${t.ranking.map((r,i)=>`${i+1}. ${r.name} (${r.w}W-${r.l}L)`).join('<br>')}`;
    c.appendChild(d);
  });
}

function deleteHistory(i){
  const h=JSON.parse(localStorage.getItem(historyKey)||'[]');
  h.splice(i,1);
  localStorage.setItem(historyKey,JSON.stringify(h));
  renderHistory();
}

el('exportHistoryBtn').onclick=()=>{
  const h=localStorage.getItem(historyKey)||'[]';
  const blob=new Blob([h],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='raiderz_history.txt';
  a.click();
};

el('importHistoryBtn').onclick=()=>el('importFile').click();
el('importFile').onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{localStorage.setItem(historyKey,r.result);renderHistory();};
  r.readAsText(e.target.files[0]);
};

renderHistory();
</script>

</body>
</html>


